<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SBX Quote Builder</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React + ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root{
      --sbx-blue:#004aac;
      --sbx-text:#0f172a;
      --sbx-mute:#64748b;
      --sbx-bg:#f6f7fb;
      --card-min-h: 360px;
    }
    html,body{height:100%}
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background:var(--sbx-bg);
      color:var(--sbx-text);
    }
    .card{background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(2,6,23,0.08);min-height:var(--card-min-h)}

    /* Step pill: clearer text, huge arrows on desktop */
    .step-badge{
      display:inline-flex;align-items:center;gap:10px;
      padding:7px 14px;border-radius:999px;
      background:linear-gradient(135deg,#0a56d4,#003b8a);
      color:#fff;
      font-weight:600; /* slightly thinner for readability */
      font-size:14px;letter-spacing:.01em;
      box-shadow:0 4px 12px rgba(0,57,117,.25), inset 0 0 0 1px rgba(255,255,255,.15);
      -webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;
    }
    .step-arrow{
      line-height:1;
      /* Mobile default kept light and small—overridden on desktop below */
      font-size:24px;
      color:#e6f0ff;
      transform: translateY(-1px);
      text-shadow:none;
    }

    /* Desktop-only: make the arrows HUGE, thick, with depth */
    @media (min-width: 1024px){
      .step-arrow{
        font-size:56px;
        font-weight:900;
        color:#ffffff;
        -webkit-text-stroke: 2px rgba(0,0,0,0.18); /* edge definition */
        text-shadow:
          0 2px 0 #0b3e86,
          0 6px 12px rgba(0,0,0,.25);
        transform: translateY(-2px);
      }
    }

    input[type="checkbox"], input[type="radio"]{accent-color:var(--sbx-blue);cursor:pointer}
    .chk{width:20px;height:20px;display:inline-block;vertical-align:top}
    .sub-check{width:18px;height:18px;display:inline-block;vertical-align:top}
    .radio-lg{width:22px;height:22px}
    .vat-chk{width:18px;height:18px}
    select, input[type="number"], input[type="text"], input[type="date"]{font-size:15px}

    /* Force uniform sizing inside Ltd inclusions block */
    .inc-ltd input[type="checkbox"]{
      width:20px;height:20px;min-width:20px;min-height:20px;
      appearance:auto;-webkit-appearance:auto;line-height:1;
      display:inline-block;
    }

    @media (max-width: 1023px){
      .arrow-override-down .step-arrow::after{content:"↓"}
      .step-arrow{font-size:24px}
    }
    @media print{
      .no-print{display:none!important}
      .print-area{box-shadow:none!important;padding:0!important}
      body{background:#fff}
    }
    .locked:hover::after{
      content:"This is standard in limited company packages";
      position:absolute;left:0;top:100%;margin-top:6px;
      background:#0f172a;color:#fff;font-size:12px;padding:6px 8px;border-radius:8px;
      white-space:nowrap;box-shadow:0 6px 20px rgba(0,0,0,.18);
    }
    .locked-pship:hover::after{
      content:"This is standard in partnership packages";
      position:absolute;left:0;top:100%;margin-top:6px;
      background:#0f172a;color:#fff;font-size:12px;padding:6px 8px;border-radius:8px;
      white-space:nowrap;box-shadow:0 6px 20px rgba(0,0,0,.18);
    }
    .locked-ind:hover::after{
      content:"Included in the sole trader package";
      position:absolute;left:0;top:100%;margin-top:6px;
      background:#0f172a;color:#fff;font-size:12px;padding:6px 8px;border-radius:8px;
      white-space:nowrap;box-shadow:0 6px 20px rgba(0,0,0,.18);
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const currency = n=>"£"+(Math.round(n*100)/100).toFixed(2);

    const REVENUE_TIERS=[
      {key:"u30",label:"Under £30k",min:0,max:30000,multiplier:1.00},
      {key:"30_90",label:"£30k – £90k",min:30000,max:90000,multiplier:1.10},
      {key:"90_150",label:"£90k – £150k",min:90000,max:150000,multiplier:1.20},
      {key:"150_250",label:"£150k – £250k",min:150000,max:250000,multiplier:1.35},
      {key:"250_350",label:"£250k – £350k",min:250000,max:350000,multiplier:1.45},
      {key:"350p",label:"£350k+",min:350000,max:Infinity,multiplier:1.60},
    ];

    const ARROWS = { right:"→", down:"↓", left:"←", dl:"↙", dr:"↘" };

    const Section = ({stepLabel,arrow,title,subtitle,children,isMobile})=>(
      <div className={`card p-6 h-full flex flex-col ${isMobile?'arrow-override-down':''}`}>
        <div className="mb-3 flex items-center justify-between">
          <span className="step-badge">
            Step&nbsp;{stepLabel}
            <span className="step-arrow">{isMobile ? "" : (ARROWS[arrow] || "")}</span>
          </span>
        </div>
        <h2 className="text-xl font-semibold text-[var(--sbx-blue)]">{title}</h2>
        {subtitle && <p className="text-sm text-[var(--sbx-mute)] mt-1">{subtitle}</p>}
        <div className="mt-3 flex-1">{children}</div>
      </div>
    );

    function useIsDesktop() {
      const [isDesktop,setIsDesktop]=React.useState(() => window.matchMedia("(min-width:1024px)").matches);
      React.useEffect(()=>{
        const mq=window.matchMedia("(min-width:1024px)");
        const handler=()=>setIsDesktop(mq.matches);
        mq.addEventListener ? mq.addEventListener("change",handler) : mq.addListener(handler);
        return ()=> mq.removeEventListener ? mq.removeEventListener("change",handler) : mq.removeListener(handler);
      },[]);
      return isDesktop;
    }

    function useQuoteState(){
      const [step,setStep]=React.useState(1);

      // Entity
      const [who,setWho]=React.useState("limited"); // limited|partnership|individual|landlord
      const [companyType,setCompanyType]=React.useState("standard"); // standard|property|startup
      const [tierKey,setTierKey]=React.useState("30_90");
      const [isTrades,setIsTrades]=React.useState(false);
      const [dormant,setDormant]=React.useState(false);
      const [yearEnd,setYearEnd]=React.useState("");
      const [ltdBookkeepingDone,setLtdBookkeepingDone]=React.useState("done"); // "done" | "not"

      // Counts
      const [employees,setEmployees]=React.useState(0); // start at 0 (extra employees)
      const [spvProperties,setSpvProperties]=React.useState(1);
      const [personalProperties,setPersonalProperties]=React.useState(1); // landlord default = 1

      // Inclusions
      const [includePayroll,setIncludePayroll]=React.useState(true);
      const [includeBookkeeping,setIncludeBookkeeping]=React.useState(true);
      const [includeSingleSA,setIncludeSingleSA]=React.useState(true);

      // VAT
      const [vatRegistered,setVatRegistered]=React.useState(false);
      const [vatReturns,setVatReturns]=React.useState(false);

      // Individual intent
      const [isSoleBusiness,setIsSoleBusiness]=React.useState(true);
      const [saNonBusiness,setSaNonBusiness]=React.useState(false);
      const [saSoleBusiness,setSaSoleBusiness]=React.useState(true);

      // Bookkeeping (partnership/individual)
      const [bkDoWeDoIt,setBkDoWeDoIt]=React.useState(false);

      // Partnership
      const [numPartnersSA,setNumPartnersSA]=React.useState(2);
      const [partnershipType,setPartnershipType]=React.useState("ordinary"); // ordinary | llp
      const [nonUkPartners,setNonUkPartners]=React.useState(false);

      // Limited extras
      const [additionalDirectorSAs,setAdditionalDirectorSAs]=React.useState(0);
      const [formation,setFormation]=React.useState(false);

      // Trades / CIS
      const [isCISContractor,setIsCISContractor]=React.useState(false);
      const [isCISSubcontractor,setIsCISSubcontractor]=React.useState(false);
      const [cisMonthlyReturns,setCisMonthlyReturns]=React.useState(false);
      const [cisSubbies,setCisSubbies]=React.useState(0);
      const [trackCISStatements,setTrackCISStatements]=React.useState(false);

      // Landlord ownership + partner SA
      const [personallyOwned,setPersonallyOwned]=React.useState(true);
      const [jointlyOwned,setJointlyOwned]=React.useState(false);
      const [otherPartnerSA,setOtherPartnerSA]=React.useState(false);

      // Specialist
      const [ihtReview,setIhtReview]=React.useState(false);
      const [trustsWork,setTrustsWork]=React.useState(false);
      const [cgtWork,setCgtWork]=React.useState(false);
      const [propIncorpReview,setPropIncorpReview]=React.useState(false);
      const [p11d,setP11d]=React.useState(false);
      const [p11dEmployees,setP11dEmployees]=React.useState(1);
      const [dirPayOptimiser,setDirPayOptimiser]=React.useState(false); // only for limited
      const [mortgageAdvice,setMortgageAdvice]=React.useState(false);

      // Auto-enrolment (Ltd + Partnership)
      const [aePension,setAePension]=React.useState(false);

      // --- Effects ---
      React.useEffect(()=>{
        if(dormant){
          setEmployees(0);
          setSpvProperties(0);
          setIncludePayroll(false);
          setIncludeBookkeeping(false);
          setIncludeSingleSA(false);
          setVatRegistered(false);
          setVatReturns(false);
          setTierKey("u30"); // dormant -> under £30k band
        }
      },[dormant]);

      // VAT auto-setting: manual for SPV/Start-up, auto if >£90k otherwise
      React.useEffect(()=>{
        const idx = REVENUE_TIERS.findIndex(t=>t.key===tierKey);
        const over90 = idx>=2;
        if(who==="limited" && (companyType==="property" || companyType==="startup")){
          /* manual */
        }else{
          setVatRegistered(over90);
          setVatReturns(over90);
        }
      },[tierKey, who, companyType]);

      // SPV defaults when toggled
      React.useEffect(()=>{
        if(who==="limited" && companyType==="property"){
          setIncludeBookkeeping(true);
          setIncludePayroll(false);
          setIncludeSingleSA(false);
          setVatRegistered(false);
          setVatReturns(false);
        }
      },[companyType, who]);

      // Start-up defaults
      React.useEffect(()=>{
        if(who==="limited" && companyType==="startup"){
          setTierKey("u30");
          setIncludeBookkeeping(true);
          setIncludePayroll(false);
          setIncludeSingleSA(true);
        }
      },[companyType, who]);

      // Standard should not include payroll by default
      React.useEffect(()=>{
        if(who==="limited" && companyType==="standard"){
          setIncludePayroll(false);
        }
      },[companyType, who]);

      // If Standard + Under £30k, keep payroll manual
      React.useEffect(()=>{
        if(who==="limited" && companyType==="standard" && tierKey==="u30"){
          setIncludePayroll(false);
        }
      },[who, companyType, tierKey]);

      // Sole trader employees default 0
      React.useEffect(()=>{
        if(who==="individual") setEmployees(0);
      },[who]);

      // Ltd: when payroll toggled on, default extra employees to 0
      React.useEffect(()=>{
        if(who==="limited" && includePayroll){ setEmployees(0); }
      },[who, includePayroll]);

      // Solo SA vs business
      React.useEffect(()=>{
        if(who!=="individual") return;
        if(isSoleBusiness){
          setSaSoleBusiness(true);
          setSaNonBusiness(false);
        }else{
          setSaSoleBusiness(false);
          setSaNonBusiness(true);
        }
      },[who,isSoleBusiness]);

      return {
        step,setStep,
        who,setWho,companyType,setCompanyType,tierKey,setTierKey,
        isTrades,setIsTrades,dormant,setDormant,yearEnd,setYearEnd,
        ltdBookkeepingDone,setLtdBookkeepingDone,
        employees,setEmployees,spvProperties,setSpvProperties,personalProperties,setPersonalProperties,
        includePayroll,setIncludePayroll,includeBookkeeping,setIncludeBookkeeping,includeSingleSA,setIncludeSingleSA,
        vatRegistered,setVatRegistered,vatReturns,setVatReturns,
        isSoleBusiness,setIsSoleBusiness,saNonBusiness,setSaNonBusiness,saSoleBusiness,setSaSoleBusiness,
        bkDoWeDoIt,setBkDoWeDoIt,
        numPartnersSA,setNumPartnersSA,
        partnershipType,setPartnershipType,nonUkPartners,setNonUkPartners,
        additionalDirectorSAs,setAdditionalDirectorSAs,formation,setFormation,
        isCISContractor,setIsCISContractor,isCISSubcontractor,setIsCISSubcontractor,cisMonthlyReturns,setCisMonthlyReturns,cisSubbies,setCisSubbies,trackCISStatements,setTrackCISStatements,
        personallyOwned,setPersonallyOwned,jointlyOwned,setJointlyOwned,otherPartnerSA,setOtherPartnerSA,
        ihtReview,setIhtReview,trustsWork,setTrustsWork,cgtWork,setCgtWork,propIncorpReview,setPropIncorpReview,
        p11d,setP11d,p11dEmployees,setP11dEmployees,
        dirPayOptimiser,setDirPayOptimiser,
        mortgageAdvice,setMortgageAdvice,
        aePension,setAePension
      };
    }

    function monthsBetween(a,b){
      const d1 = new Date(a), d2 = new Date(b);
      let months = (d2.getFullYear()-d1.getFullYear())*12 + (d2.getMonth()-d1.getMonth());
      if (d2.getDate() < d1.getDate()) months -= 1;
      return months;
    }
    function monthsSince(dateStr){
      if(!dateStr) return 0;
      return Math.max(0, monthsBetween(dateStr, new Date()));
    }
    function monthsSinceTaxYearStart(){
      const now = new Date();
      const currentYear = now.getFullYear();
      const taxYearStart = new Date((now < new Date(currentYear,3,6)) ? currentYear-1 : currentYear,3,6);
      let months = (now.getFullYear()-taxYearStart.getFullYear())*12 + (now.getMonth()-taxYearStart.getMonth());
      if (now.getDate() < taxYearStart.getDate()) months -= 1;
      return Math.max(0, months);
    }

    // CIS monthly pricing by pairs: 1–2=15, 3–4=25, 5–6=35, +10 per extra pair
    const cisMonthlyCost = (n)=>{
      if(n<=0) return 15; // nil return still £15/mo
      const buckets = Math.ceil(n/2);
      return 5 + 10*buckets;
    };

    // Sole trader monthly package tables
    const SOLE_PKG_CLIENT_BK = {u30:20,"30_90":25,"90_150":35,"150_250":45,"250_350":55,"350p":65};
    const SOLE_PKG_SBX_BK    = {u30:30,"30_90":40,"90_150":50,"150_250":60,"250_350":70,"350p":80};

    // Partnership monthly package tables
    const PSHIP_PKG_CLIENT_BK = {u30:30,"30_90":45,"90_150":60,"150_250":75,"250_350":90,"350p":105};
    const PSHIP_PKG_SBX_BK    = {u30:45,"30_90":65,"90_150":85,"150_250":105,"250_350":125,"350p":145};
    const LLP_MARKUP = 1.15; // +15% for LLP complexity

    function calcPricing(s){
      const tier = REVENUE_TIERS.find(t=>t.key===s.tierKey) || REVENUE_TIERS[0];
      const m = tier.multiplier;

      const monthly=[], oneoff=[];
      let bkMonthlyForCatchup = 0;

      const allowMonthly =
        !(s.who==="limited" && s.dormant) &&
        s.who!=="landlord" &&
        !(s.who==="individual" && !s.isSoleBusiness);

      if(allowMonthly){
        if(s.who==="limited"){
          // Treat Standard+Under£30k as Start-up for pricing
          const treatAsStartup = (s.companyType==="startup") || (s.companyType==="standard" && s.tierKey==="u30");

          if(treatAsStartup){
            const base = 55;
            monthly.push({label:"Start-up Company Package",note:"Under £30k revenue · YE accounts & CT return · 1 director SA · CS filing (we cover £34) · QuickBooks · Bookkeeping",amount:base});
            if(s.includePayroll){
              monthly.push({label:"Payroll (1–2)",amount:10});
              if(s.aePension) monthly.push({label:"Auto-enrolment pension administration",amount:6 + Math.max(0,s.employees)*1});
            }
            if(s.vatRegistered && s.vatReturns){
              monthly.push({label:"VAT Returns (averaged monthly)",amount:25});
            }
          } else if(s.companyType==="property"){
            const spvBase = (55 + Math.max(0,s.spvProperties-1)*5) * m;
            monthly.push({
              label:"Property Company Package (SPV)",
              note:`Includes YE accounts & CT return, confirmation statement (we cover £34), bookkeeping · ${s.spvProperties} propert${s.spvProperties===1?'y':'ies'}`,
              amount:spvBase
            });
            if(s.includePayroll){
              const extra = Math.max(0, s.employees) * 10;
              monthly.push({label:"Payroll (SPV)", amount:Math.max(10, extra)});
              if(s.aePension) monthly.push({label:"Auto-enrolment pension administration",amount:6 + Math.max(0,s.employees)*1});
            }
            if(s.includeSingleSA){
              monthly.push({label:"Single director Self Assessment (SPV add-on)", amount:10});
            }
            if(s.vatRegistered && s.vatReturns){
              monthly.push({label:"VAT Returns (averaged monthly)",amount:25});
            }
          } else {
            // Standard company package: base £90 (no payroll included)
            const base = 90;
            monthly.push({
              label:"Standard Company Package",
              note:"For >£30k revenue · YE accounts & CT return · single director Self Assessment · confirmation statement (we cover £34) · QuickBooks · bookkeeping · Price can reduce if you remove items.",
              amount:base
            });
            if(s.includePayroll){
              monthly.push({label:"Payroll (1–2)", amount:10});
              // extras beyond 2 employees charged at £4 each
              const extra = Math.max(0, s.employees) * 4;
              if(extra>0) monthly.push({label:"Payroll add-on (additional employees)",amount:extra});
              if(s.aePension) monthly.push({label:"Auto-enrolment pension administration",amount:6 + Math.max(0,s.employees)*1});
            }
            if(!s.includeBookkeeping) monthly.push({label:"Bookkeeping removed", amount:-20});
            if(!s.includeSingleSA)    monthly.push({label:"Single director SA removed", amount:-10});
            if(s.vatRegistered && s.vatReturns){
              monthly.push({label:"VAT Returns (averaged monthly)",amount:25});
            }
          }
        } else if(s.who==="partnership"){
          const pkgBase = s.bkDoWeDoIt ? PSHIP_PKG_SBX_BK : PSHIP_PKG_CLIENT_BK;
          let amount = pkgBase[s.tierKey] ?? 45;
          if(s.partnershipType==="llp") amount = amount * LLP_MARKUP; // LLP uplift
          monthly.push({
            label:"Partnership Package (monthly)",
            note: (s.bkDoWeDoIt ? "Includes bookkeeping & QuickBooks subscription" : "Excludes bookkeeping (you’ll do it)") + (s.partnershipType==="llp" ? " · LLP uplift applied" : ""),
            amount
          });
          if(s.bkDoWeDoIt){
            bkMonthlyForCatchup = amount;
          }
          if(s.vatRegistered && s.vatReturns) monthly.push({label:"VAT Returns (averaged monthly)",amount:20});
          if(s.employees>0){
            monthly.push({label:"Payroll add-on",amount:10*s.employees});
            if(s.aePension) monthly.push({label:"Auto-enrolment pension administration",amount:6 + Math.max(0,s.employees)*1});
          }
        } else if(s.who==="individual" && s.isSoleBusiness){
          const pkg = s.bkDoWeDoIt ? SOLE_PKG_SBX_BK : SOLE_PKG_CLIENT_BK;
          const amount = pkg[s.tierKey] ?? 30;
          monthly.push({
            label:"Sole Trader Package (monthly, after initial year)",
            note: s.bkDoWeDoIt ? "We do bookkeeping (includes QuickBooks)" : "You’ll do your own bookkeeping",
            amount
          });
          if(s.vatRegistered && s.vatReturns) monthly.push({label:"VAT Returns (averaged monthly)",amount:15});
          if(s.employees>0) monthly.push({label:"Payroll add-on",amount:10*s.employees});
        }

        // CIS monthly (Contractor) — includes nil returns at £15
        if(s.isTrades && s.isCISContractor && s.cisMonthlyReturns){
          const amt = cisMonthlyCost(s.cisSubbies);
          monthly.push({
            label:"CIS Monthly Returns (contractor)",
            note: s.cisSubbies===0 ? "nil return submissions" : `for ${s.cisSubbies} subcontractor${s.cisSubbies===1?'':'s'}`,
            amount:amt
          });
        }
      }

      // ---- ONE-OFFS ----
      if(s.who==="limited" && s.dormant){
        oneoff.push({label:"Dormant Accounts & Confirmation Statement",amount:200});
      }

      if(s.who==="limited" && s.formation){
        oneoff.push({label:"Company formation (SBX fee)",note:"Free with our monthly packages",amount:0});
        oneoff.push({label:"Companies House incorporation fee",note:"We will recharge the cost of £50 to you after",amount:50});
      }

      // LIMITED backdating / compliance rules
      if(s.who==="limited" && !s.dormant && s.yearEnd){
        const ye = new Date(s.yearEnd);
        const now = new Date();
        const tmpMonthlyTotal = monthly.reduce((a,b)=>a+(b.amount||0),0);

        if(ye < now){
          // PAST year-end: one-off compliance only
          const monthsFactor = (s.ltdBookkeepingDone==="done") ? 7.5 : 10;
          if(tmpMonthlyTotal>0){
            oneoff.push({
              label:`Year-end compliance package (${s.ltdBookkeepingDone==="done"?"BK done":"no BK"} for that year)`,
              note:`Charged once for the year just ended`,
              amount:monthsFactor * tmpMonthlyTotal
            });
          }
        } else {
          // FUTURE year-end: current-year catch-up (beyond first 4 months)
          const start = new Date(ye);
          start.setFullYear(start.getFullYear()-1);
          const elapsed = Math.max(0, monthsBetween(start, now)); // months in the current period so far
          const billable = Math.max(0, elapsed - 4);
          if(billable>0 && tmpMonthlyTotal>0){
            oneoff.push({
              label:`Bookkeeping catch-up — ${billable} month${billable>1?'s':''} (based on your monthly package)`,
              amount:billable*tmpMonthlyTotal
            });
          }
        }
      }

      // Partnership catch-up (only when we do bookkeeping)
      if(s.who==="partnership" && s.bkDoWeDoIt){
        const months = monthsSinceTaxYearStart();
        const billable = Math.max(0, months - 4);
        if(billable>0 && bkMonthlyForCatchup>0){
          oneoff.push({label:`Bookkeeping catch-up (partnership) — ${billable} month${billable>1?'s':''} from start of tax year`,amount:billable*bkMonthlyForCatchup});
        }
      }

      // Individual one-offs — SA scales from £200 with tier multipliers
      if(s.who==="individual" && s.isSoleBusiness && s.saSoleBusiness){
        const base = 200;
        const sa = Math.round(base * (REVENUE_TIERS.find(t=>t.key===s.tierKey)?.multiplier || 1));
        oneoff.push({label:"Self-Assessment (sole trader business)",note:REVENUE_TIERS.find(t=>t.key===s.tierKey).label,amount:sa});
      }
      if(s.who==="individual" && !s.isSoleBusiness && s.saNonBusiness){
        oneoff.push({label:"Self-Assessment (personal — investments/other)",amount:150});
      }

      // Landlord one-offs
      if(s.who==="landlord"){
        const base = 150 + Math.max(0, s.personalProperties-1)*20;
        oneoff.push({label:"Self-Assessment (personal landlord)",note:`${s.personalProperties} rental propert${s.personalProperties===1?'y':'ies'}`,amount:base});
        if(s.jointlyOwned && s.otherPartnerSA){
          oneoff.push({label:"Self-Assessment for joint partner (landlord)",amount:base});
        }
      }

      // Extras
      if(s.who==="partnership" && s.numPartnersSA>0){
        oneoff.push({label:`Partners' Self Assessments ×${s.numPartnersSA}`,note:"Billed initially; from year two this is reflected in the monthly package.",amount:150*s.numPartnersSA});
      }
      if(s.who==="limited" && s.additionalDirectorSAs>0 && s.includeSingleSA){
        oneoff.push({label:`Additional directors (Self Assessment) ×${s.additionalDirectorSAs}`,amount:120*s.additionalDirectorSAs});
      }
      if(s.isTrades && s.isCISSubcontractor && s.trackCISStatements){
        oneoff.push({label:"CIS statements tracking (subcontractor)",note:"Free",amount:0});
      }
      if(s.ihtReview)        oneoff.push({label:"IHT review & recommendations",amount:250});
      if(s.trustsWork)       oneoff.push({label:"Trusts / family investment structures – consult",amount:150});
      if(s.cgtWork)          oneoff.push({label:"CGT planning / disposal review",amount:150});
      if(s.propIncorpReview) oneoff.push({label:"Property incorporation (SDLT/CGT) review",amount:295});
      if(s.p11d)             oneoff.push({label:`P11D preparation ×${s.p11dEmployees}`,amount:30*s.p11dEmployees});
      if(s.mortgageAdvice)   oneoff.push({label:"Mortgage/portfolio finance advice session",note:"BTL structure, product options, affordability & tax interface",amount:120});
      if(s.dirPayOptimiser && s.who==="limited" && s.companyType!=="property"){
        oneoff.push({label:"Director’s Pay Optimiser (tailored summary)",note:"Free",amount:0});
      }

      const monthlyTotal = monthly.reduce((a,b)=>a+(b.amount||0),0);
      const oneOffTotal  = oneoff.reduce((a,b)=>a+(b.amount||0),0);
      return {monthly, oneoff, monthlyTotal, oneOffTotal};
    }

    function SnakeGrid({sections}) {
      const isDesktop = useIsDesktop();
      if(!isDesktop){
        return (
          <div className="grid grid-cols-1 gap-6">
            {sections.map((sec,i)=>(
              <Section key={i} stepLabel={sec.step} arrow={"down"} title={sec.title} subtitle={sec.subtitle} isMobile>
                {sec.content}
              </Section>
            ))}
          </div>
        );
      }
      return null;
    }

    function InputsSnake({ s, onNext }) {
      const isDesktop = useIsDesktop();

      const showCIS = s.isTrades && (s.who==="limited" || s.who==="partnership" || (s.who==="individual" && s.isSoleBusiness));
      let showRevenue = !(s.who==="landlord" || (s.who==="individual" && !s.isSoleBusiness));

      const s1 = {
        key:"s1", step:"1", title:"Who is this for?", subtitle:"",
        content:(
          <div className="grid gap-3">
            <label className={`flex items-start gap-4 p-4 border rounded-xl cursor-pointer ${s.who==="limited"?"border-[var(--sbx-blue)] bg-blue-50/40":"border-slate-200"}`}>
              <input className="radio-lg" type="radio" name="who" checked={s.who==="limited"} onChange={()=>s.setWho("limited")} />
              <div className="font-medium">Limited Company</div>
            </label>
            <label className={`flex items-start gap-4 p-4 border rounded-xl cursor-pointer ${s.who==="partnership"?"border-[var(--sbx-blue)] bg-blue-50/40":"border-slate-200"}`}>
              <input className="radio-lg" type="radio" name="who" checked={s.who==="partnership"} onChange={()=>s.setWho("partnership")} />
              <div className="font-medium">Partnership</div>
            </label>
            <label className={`flex items-start gap-4 p-4 border rounded-xl cursor-pointer ${s.who==="individual"?"border-[var(--sbx-blue)] bg-blue-50/40":"border-slate-200"}`}>
              <input className="radio-lg" type="radio" name="who" checked={s.who==="individual"} onChange={()=>s.setWho("individual")} />
              <div className="font-medium">Individual / Sole Trader</div>
            </label>
            <label className={`flex items-start gap-4 p-4 border rounded-xl cursor-pointer ${s.who==="landlord"?"border-[var(--sbx-blue)] bg-blue-50/40":"border-slate-200"}`}>
              <input className="radio-lg" type="radio" name="who" checked={s.who==="landlord"} onChange={()=>s.setWho("landlord")} />
              <div className="font-medium">Personal Landlord</div>
            </label>
          </div>
        )
      };

      const s2 = {
        key:"s2", step:"2", title:"Business profile",
        subtitle:(()=>{
          if(s.who==="limited")   return "Company type, year end, and any SPV properties";
          if(s.who==="partnership")return "Basic details — we'll tailor services below";
          if(s.who==="individual") return "For an individual, what is most appropriate for you?";
          if(s.who==="landlord")   return "Tell us about your property ownership";
          return "";
        })(),
        content:(
          <>
            {/* LIMITED */}
            {s.who==="limited" && (
              <div className="grid gap-3 mb-4">
                <label className={`flex items-start gap-3 p-4 border rounded-xl cursor-pointer ${s.companyType==="standard"?"border-[var(--sbx-blue)] bg-blue-50/40":"border-slate-200"}`}>
                  <input className="radio-lg" type="radio" name="coType" checked={s.companyType==="standard"} onChange={()=>s.setCompanyType("standard")}/>
                  <div>
                    <div className="font-medium">Standard Limited Company</div>
                    <p className="text-sm leading-snug text-[var(--sbx-mute)] mt-1">
                      <strong>For &gt;£30k revenue</strong>. <strong>£90pm</strong> base includes <em>year-end accounts &amp; CT return, single director Self Assessment, confirmation statement (we cover the £34 fee), QuickBooks, and bookkeeping</em>. You can reduce the price if some items aren’t needed.
                    </p>
                  </div>
                </label>

                {/* Start-up Package */}
                <label className={`flex items-start gap-3 p-4 border rounded-xl cursor-pointer ${s.companyType==="startup"?"border-[var(--sbx-blue)] bg-blue-50/40":"border-slate-200"}`}>
                  <input className="radio-lg" type="radio" name="coType" checked={s.companyType==="startup"} onChange={()=>s.setCompanyType("startup")}/>
                  <div>
                    <div className="font-medium">Start-up Package</div>
                    <p className="text-sm leading-snug text-[var(--sbx-mute)] mt-1">
                      For <strong>new companies under £30k revenue</strong>. Package is <strong>£55pm</strong> (payroll optional +£10pm). VAT can apply if you register voluntarily.
                    </p>
                  </div>
                </label>

                <label className={`flex items-start gap-3 p-4 border rounded-xl cursor-pointer ${s.companyType==="property"?"border-[var(--sbx-blue)] bg-blue-50/40":"border-slate-200"}`}>
                  <input className="radio-lg" type="radio" name="coType" checked={s.companyType==="property"} onChange={()=>s.setCompanyType("property")}/>
                  <div>
                    <div className="font-medium">Property Investment Company (SPV)</div>
                    <p className="text-sm leading-snug text-[var(--sbx-mute)] mt-1">From <strong>£55pm</strong>; usually not VAT registered.</p>
                  </div>
                </label>

                {/* Trades + Dormant side-by-side */}
                <div className="grid md:grid-cols-2 gap-4">
                  <label className="flex items-center gap-2 text-sm">
                    <input className="chk" id="trades" type="checkbox" checked={s.isTrades} onChange={e=>s.setIsTrades(e.target.checked)} />
                    <span>Trades / construction business</span>
                  </label>
                  <label className="flex items-center gap-2 text-sm">
                    <input className="chk" id="dormant" type="checkbox" checked={s.dormant} onChange={e=>s.setDormant(e.target.checked)} />
                    <span>Company is dormant / not trading</span>
                  </label>
                </div>

                {/* Year end + SPV properties side-by-side, spaced */}
                <div className="grid md:grid-cols-2 gap-6">
                  <div>
                    <label className="block text-sm mb-1">Company year end date</label>
                    <input type="date" value={s.yearEnd} onChange={e=>s.setYearEnd(e.target.value)} className="w-full md:w-[260px] border rounded-xl px-3 py-2"/>
                    <p className="text-xs text-[var(--sbx-mute)] mt-1">Enter the year-end date you want us to handle (your next filing). We’ll apply the correct catch-up/compliance approach automatically.</p>

                    {/* Show bookkeeping done/not if year end is past */}
                    {!!s.yearEnd && new Date(s.yearEnd) < new Date() && !s.dormant && (
                      <div className="mt-2">
                        <label className="block text-sm mb-1">Bookkeeping status for that year</label>
                        <select value={s.ltdBookkeepingDone} onChange={e=>s.setLtdBookkeepingDone(e.target.value)} className="w-full md:w-[320px] border rounded-xl px-3 py-2 text-sm">
                          <option value="done">We’ve done our bookkeeping for that year</option>
                          <option value="not">We haven’t done bookkeeping for that year</option>
                        </select>
                      </div>
                    )}
                  </div>
                  {s.companyType==="property" && (
                    <div className="md:ml-2">
                      <label className="block text-sm mb-1">Number of properties in SPV</label>
                      <input type="number" min="0" value={s.spvProperties} onChange={e=>s.setSpvProperties(Number(e.target.value)||0)} className="w-full md:w-[220px] border rounded-xl px-3 py-2"/>
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* PARTNERSHIP */}
            {s.who==="partnership" && (
              <div className="grid gap-4 mb-4">
                <div className="grid md:grid-cols-2 gap-4">
                  <div className="p-3 border rounded-xl">
                    <p className="font-medium mb-2">Partnership type</p>
                    <label className="flex items-center gap-2 text-sm mb-2">
                      <input className="radio-lg" type="radio" name="ptype" checked={s.partnershipType==="ordinary"} onChange={()=>s.setPartnershipType("ordinary")}/> Ordinary partnership
                    </label>
                    <label className="flex items-center gap-2 text-sm">
                      <input className="radio-lg" type="radio" name="ptype" checked={s.partnershipType==="llp"} onChange={()=>s.setPartnershipType("llp")}/> LLP
                    </label>
                  </div>
                  <div className="p-3 border rounded-xl">
                    <p className="font-medium mb-2">Other details</p>
                    <label className="flex items-center gap-2 text-sm">
                      <input className="chk" type="checkbox" checked={s.nonUkPartners} onChange={e=>s.setNonUkPartners(e.target.checked)}/> Non-UK resident partners
                    </label>
                  </div>
                </div>

                {/* Trades toggle (shows CIS when ticked) */}
                <label className="flex items-center gap-2 text-sm">
                  <input className="chk" type="checkbox" checked={s.isTrades} onChange={e=>s.setIsTrades(e.target.checked)}/> Trades / construction business
                </label>
              </div>
            )}

            {/* INDIVIDUAL */}
            {s.who==="individual" && (
              <>
                <div className="p-3 border rounded-xl order-1">
                  <p className="font-medium mb-2">For an individual, what is most appropriate for you?</p>
                  <label className="flex items-center gap-2 text-sm mb-2">
                    <input className="radio-lg" type="radio" name="indType" checked={s.isSoleBusiness} onChange={()=>s.setIsSoleBusiness(true)}/> I run a business (sole trader)
                  </label>
                  <label className="flex items-center gap-2 text-sm mb-0.5">
                    <input className="radio-lg" type="radio" name="indType" checked={!s.isSoleBusiness} onChange={()=>s.setIsSoleBusiness(false)}/> I need a Self-Assessment for other untaxed income (investments/other)
                  </label>
                </div>
                {/* Trades toggle OUTSIDE the box */}
                {s.isSoleBusiness && (
                  <label className="flex items-center gap-2 text-sm mt-2">
                    <input className="chk" type="checkbox" checked={s.isTrades} onChange={e=>s.setIsTrades(e.target.checked)}/> Trades / construction business
                  </label>
                )}
              </>
            )}

            {/* LANDLORD */}
            {s.who==="landlord" && (
              <div className="space-y-3">
                <div>
                  <label className="block text-sm mb-1">Personal rental properties</label>
                  <input type="number" min="1" value={s.personalProperties} onChange={e=>s.setPersonalProperties(Number(e.target.value)||1)} className="w-full border rounded-xl px-3 py-2"/>
                </div>
                <div className="text-sm">
                  <label className="mr-6"><input className="chk" type="checkbox" checked={s.personallyOwned} onChange={e=>s.setPersonallyOwned(e.target.checked)}/> Personally owned</label>
                  <label className=""><input className="chk" type="checkbox" checked={s.jointlyOwned} onChange={e=>s.setJointlyOwned(e.target.checked)}/> Jointly owned</label>
                </div>
              </div>
            )}

            {/* New signup notes */}
            {s.who==="limited" && (
              <div className="text-xs text-[var(--sbx-mute)] mt-2">
                New Ltd Co signup: <strong>4 months</strong> of backdated bookkeeping free.
              </div>
            )}
            {s.who==="partnership" && (
              <div className="text-xs text-[var(--sbx-mute)] mt-2">
                New partnership signup: up to <strong>4 months</strong> of backdated bookkeeping free (aligned to the UK tax year) — if we handle bookkeeping.
              </div>
            )}
          </>
        )
      };

      const s2a = showCIS ? {
        key:"s2a", step:"2a", title:"CIS options", subtitle:"Contractors and Subcontractors",
        content:(
          <div className="grid md:grid-cols-2 gap-4">
            <div className="p-3 border rounded-xl">
              <p className="font-medium mb-2">Contractor</p>
              <label className="flex items-center gap-3 text-sm mb-2">
                <input className="chk" type="checkbox" checked={s.isCISContractor} onChange={e=>s.setIsCISContractor(e.target.checked)}/> I’m a CIS contractor
              </label>
              {s.isCISContractor && (
                <>
                  <label className="flex items-center gap-3 text-sm mb-2">
                    <input className="sub-check" type="checkbox" checked={s.cisMonthlyReturns} onChange={e=>s.setCisMonthlyReturns(e.target.checked)}/> CIS monthly returns
                  </label>
                  <div className="flex items-center gap-2 text-sm mb-2">
                    <span>Subcontractors:</span>
                    <input type="number" min="0" value={s.cisSubbies} onChange={e=>s.setCisSubbies(Number(e.target.value)||0)} className="w-28 border rounded-xl px-3 py-2"/>
                  </div>
                  <div className="text-xs text-[var(--sbx-mute)]">Verification/setup: <strong>free</strong></div>
                </>
              )}
            </div>
            <div className="p-3 border rounded-xl">
              <p className="font-medium mb-2">Subcontractor</p>
              <label className="flex items-center gap-3 text-sm">
                <input className="chk" type="checkbox" checked={s.isCISSubcontractor} onChange={e=>s.setIsCISSubcontractor(e.target.checked)}/> I’m a CIS subcontractor
              </label>
              {s.isCISSubcontractor && (
                <label className="flex items-center gap-3 text-sm mt-2">
                  <input className="chk" type="checkbox" checked={s.trackCISStatements} onChange={e=>s.setTrackCISStatements(e.target.checked)}/> Track my CIS deduction statements (free)
                </label>
              )}
            </div>
          </div>
        )
      } : null;

      const s3 = showRevenue ? {
        key:"s3", step:"3", title:"Revenue band", subtitle:"",
        content:(
          <div className="space-y-3">
            <div className="grid md:grid-cols-3 gap-3">
              {(s.who==="limited" && s.companyType==="startup"
                ? REVENUE_TIERS.filter(t=>t.key==="u30")
                : REVENUE_TIERS
              ).map(t=>(
                <label key={t.key} className={`flex items-center gap-3 p-3 border rounded-xl cursor-pointer ${s.tierKey===t.key?"border-[var(--sbx-blue)] bg-blue-50/40":"border-slate-200"}`}>
                  <input className="radio-lg" type="radio" name="tier" checked={s.tierKey===t.key} onChange={()=>s.setTierKey(t.key)}/>
                  <div className="font-medium">{t.label}</div>
                </label>
              ))}
            </div>
            <label className="flex items-center gap-3 text-sm">
              <input className="vat-chk" type="checkbox" checked={s.vatRegistered} onChange={e=>{s.setVatRegistered(e.target.checked); s.setVatReturns(e.target.checked);}} />
              Are you VAT registered?
            </label>
          </div>
        )
      } : null;

      const payrollLabel = (() => {
        if(s.who==="partnership"){
          return s.partnershipType==="llp"
            ? "Employees on payroll (include salaried LLP partners)"
            : "Employees on payroll";
        }
        if(s.who==="limited") return "Additional employees on payroll (beyond 1–2 if payroll is ticked)";
        return "Employees on payroll";
      })();

      const s4 = {
        key:"s4", step:"4", title:"What’s included / adjustments", subtitle:"Tailor your package",
        content:(
          <div className="grid md:grid-cols-2 gap-6">
            <div className="space-y-3 inc-ltd">
              {/* LIMITED */}
              {s.who==="limited" && (
                <>
                  <div className="relative locked flex items-start gap-3 text-sm">
                    <input className="chk" type="checkbox" checked readOnly/>
                    <span><span className="font-medium">Year-end accounts &amp; CT return</span> (included)</span>
                  </div>
                  <div className="flex items-start gap-3 text-sm">
                    <input className="chk" type="checkbox" checked readOnly/>
                    <span><span className="font-medium">Confirmation statement</span> (we do this free &amp; cover the £34 filing fee)</span>
                  </div>
                  <label className="flex items-start gap-3 text-sm">
                    <input className="chk" type="checkbox" checked={s.includeBookkeeping} onChange={e=>s.setIncludeBookkeeping(e.target.checked)} />
                    <span><span className="font-medium">Full bookkeeping (included)</span> — includes QuickBooks subscription<br/><span className="text-[var(--sbx-mute)]">Untick to remove (shows as a deduction).</span></span>
                  </label>
                  <label className="flex items-start gap-3 text-sm">
                    <input className="chk" type="checkbox" checked={s.includePayroll} onChange={e=>s.setIncludePayroll(e.target.checked)} />
                    <span><span className="font-medium">Payroll for 1–2 staff (optional)</span></span>
                  </label>
                  <label className="flex items-start gap-3 text-sm">
                    <input className="chk" type="checkbox" checked={s.includeSingleSA} onChange={e=>s.setIncludeSingleSA(e.target.checked)} />
                    <span><span className="font-medium">Single director Self Assessment {(s.companyType==="property" || s.companyType==="startup" || (s.companyType==="standard")) ? "(optional)" : "(included)"}</span></span>
                  </label>
                </>
              )}

              {/* PARTNERSHIP */}
              {(s.who==="partnership") && (
                <>
                  <div className="relative locked-pship flex items-start gap-3 text-sm">
                    <input className="chk" type="checkbox" checked readOnly/>
                    <span><span className="font-medium">Partnership accounts &amp; SA800</span> (included)</span>
                  </div>
                  <div>
                    <label className="block text-sm mb-1">Bookkeeping</label>
                    <div className="flex flex-col gap-2">
                      <label className="flex items-center gap-2 text-sm">
                        <input className="radio-lg" type="radio" name="bk" checked={!s.bkDoWeDoIt} onChange={()=>s.setBkDoWeDoIt(false)}/> I’ll do my own bookkeeping
                      </label>
                      <label className="flex items-center gap-2 text-sm">
                        <input className="radio-lg" type="radio" name="bk" checked={s.bkDoWeDoIt} onChange={()=>s.setBkDoWeDoIt(true)}/> Please do my bookkeeping
                      </label>
                      {s.bkDoWeDoIt && (
                        <div className="text-xs text-[var(--sbx-mute)] ml-7 -mt-1">Includes QuickBooks subscription.</div>
                      )}
                    </div>
                  </div>
                </>
              )}

              {/* SOLE TRADER */}
              {(s.who==="individual" && s.isSoleBusiness) && (
                <>
                  <div className="relative locked-ind flex items-start gap-3 text-sm">
                    <input className="chk" type="checkbox" checked readOnly/>
                    <span><span className="font-medium">Year-end accounts / Self Assessment</span> (included)</span>
                  </div>
                  <div>
                    <label className="block text-sm mb-1">Bookkeeping</label>
                    <div className="flex flex-col gap-2">
                      <label className="flex items-center gap-2 text-sm">
                        <input className="radio-lg" type="radio" name="bk" checked={!s.bkDoWeDoIt} onChange={()=>s.setBkDoWeDoIt(false)}/> I’ll do my own bookkeeping
                      </label>
                      <label className="flex items-center gap-2 text-sm">
                        <input className="radio-lg" type="radio" name="bk" checked={s.bkDoWeDoIt} onChange={()=>s.setBkDoWeDoIt(true)}/> Please do my bookkeeping
                      </label>
                      {s.bkDoWeDoIt && (
                        <div className="text-xs text-[var(--sbx-mute)] ml-7 -mt-1">Includes QuickBooks subscription.</div>
                      )}
                    </div>
                  </div>
                </>
              )}

              {/* LANDLORD */}
              {s.who==="landlord" && (
                <>
                  <div className="relative flex items-start gap-3 text-sm">
                    <input className="chk" type="checkbox" checked readOnly/>
                    <span><span className="font-medium">Self-Assessment for you</span> (included by default)</span>
                  </div>
                  {s.jointlyOwned && (
                    <label className="flex items-start gap-3 text-sm">
                      <input className="chk" type="checkbox" checked={s.otherPartnerSA} onChange={e=>s.setOtherPartnerSA(e.target.checked)} />
                      <span><span className="font-medium">Include Self-Assessment for joint partner</span></span>
                    </label>
                  )}
                </>
              )}
            </div>

            <div className="space-y-3">
              {/* Partners needing SA */}
              {s.who==="partnership" && (
                <div>
                  <label className="block text-sm mb-1">Partners requiring Self Assessment</label>
                  <input type="number" min="0" value={s.numPartnersSA} onChange={e=>s.setNumPartnersSA(Number(e.target.value)||0)} className="w-full border rounded-xl px-3 py-2"/>
                  <p className="text-xs text-[var(--sbx-mute)] mt-1">Billed initially (£150 each). From year two this is reflected in the monthly package.</p>
                </div>
              )}

              {/* Employees input — Ltd shows only if Payroll ticked */}
              {!(s.who==="landlord" || (s.who==="individual" && !s.isSoleBusiness)) && (
                <>
                  {(s.who!=="limited" || s.includePayroll) && (
                    <div>
                      <label className="block text-sm mb-1">{payrollLabel}</label>
                      <input type="number" min="0" value={s.employees} onChange={e=>s.setEmployees(Number(e.target.value)||0)} className="w-full border rounded-xl px-3 py-2"/>
                    </div>
                  )}
                </>
              )}

              {s.who==="limited" && (
                <>
                  {s.includeSingleSA && (
                    <div>
                      <label className="block text-sm mb-1">Additional directors requiring Self Assessment</label>
                      <input type="number" min="0" value={s.additionalDirectorSAs} onChange={e=>s.setAdditionalDirectorSAs(Number(e.target.value)||0)} className="w-full border rounded-xl px-3 py-2"/>
                    </div>
                  )}
                  <label className="flex items-start gap-3 text-sm">
                    <input className="sub-check" type="checkbox" checked={s.formation} onChange={e=>s.setFormation(e.target.checked)} />
                    <span><span className="font-medium">Company formation</span><br/><span className="text-[var(--sbx-mute)]">Free with our monthly packages (we recharge the £50 Companies House fee to you after).</span></span>
                  </label>
                  <label className="flex items-start gap-3 text-sm">
                    <input className="chk" type="checkbox" checked={s.aePension} onChange={e=>s.setAePension(e.target.checked)} />
                    <span><span className="font-medium">Auto-enrolment pension administration</span> (optional)</span>
                  </label>
                </>
              )}

              {(s.who==="partnership" && s.employees>0) && (
                <label className="flex items-start gap-3 text-sm">
                  <input className="chk" type="checkbox" checked={s.aePension} onChange={e=>s.setAePension(e.target.checked)} />
                  <span><span className="font-medium">Auto-enrolment pension administration</span> (optional)</span>
                </label>
              )}

              {(s.vatRegistered && s.who!=="landlord") && (
                <label className="flex items-start gap-3 text-sm">
                  <input className="vat-chk" type="checkbox" checked={s.vatReturns} onChange={e=>s.setVatReturns(e.target.checked)} />
                  <span><span className="font-medium">VAT returns (averaged monthly)</span></span>
                </label>
              )}
            </div>
          </div>
        )
      };

      const s5 = {
        key:"s5", step:"5", title:"Specialist/technical work (one-off)", subtitle:"Select any that apply",
        content:(
          <div className="grid md:grid-cols-2 gap-3">
            <label className="flex items-center gap-3 text-sm"><input className="chk" type="checkbox" checked={s.ihtReview} onChange={e=>s.setIhtReview(e.target.checked)}/> IHT review (£250)</label>
            <label className="flex items-center gap-3 text-sm"><input className="chk" type="checkbox" checked={s.trustsWork} onChange={e=>s.setTrustsWork(e.target.checked)}/> Trusts / family investment structures consult (£150)</label>
            <label className="flex items-center gap-3 text-sm"><input className="chk" type="checkbox" checked={s.cgtWork} onChange={e=>s.setCgtWork(e.target.checked)}/> CGT planning / disposal review (£150)</label>
            <label className="flex items-center gap-3 text-sm"><input className="chk" type="checkbox" checked={s.propIncorpReview} onChange={e=>s.setPropIncorpReview(e.target.checked)}/> Property incorporation (SDLT/CGT) review (£295)</label>
            <div className="flex items-center gap-2 text-sm">
              <input className="chk" type="checkbox" checked={s.p11d} onChange={e=>s.setP11d(e.target.checked)}/>
              <span>P11D per employee (£30)</span>
              {s.p11d && (<><span className="ml-2">Qty:</span><input type="number" min="1" value={s.p11dEmployees} onChange={e=>s.setP11dEmployees(Number(e.target.value)||1)} className="w-20 border rounded-xl px-3 py-2"/></>)}
            </div>
            {s.who==="limited" && s.companyType!=="property" && (
              <label className="flex items-center gap-3 text-sm"><input className="chk" type="checkbox" checked={s.dirPayOptimiser} onChange={e=>s.setDirPayOptimiser(e.target.checked)}/> Director’s Pay Optimiser (free)</label>
            )}
            <label className="flex items-center gap-3 text-sm"><input className="chk" type="checkbox" checked={s.mortgageAdvice} onChange={e=>s.setMortgageAdvice(e.target.checked)}/> Mortgage / portfolio finance advice session (£120)</label>
          </div>
        )
      };

      const s6 = {
        key:"s6", step:"6", title:"Financial advisory", subtitle:"Want to talk it through?",
        content:(
          <div>
            <p className="text-sm text-[var(--sbx-mute)] mb-3">
              We can discuss structure, tax planning, property strategy, trusts, investments and CGT timing to tailor a plan.
            </p>
            <a className="inline-block px-4 py-2 rounded-xl bg-[var(--sbx-blue)] text-white text-sm font-semibold"
               href="mailto:ryan@sbxaccountants.com?subject=SBX%20Consultation%20Request&body=Hi%20SBX%2C%0A%0AI%27d%20like%20to%20book%20a%20consultation%20to%20discuss%20my%20quote%20and%20requirements.%0A%0AThanks%2C%0A">
               Email Ryan to book a consultation
            </a>
          </div>
        )
      };

      // Build sequence + special cases
      let seqBase = [s1, s2, ...(showCIS?[s2a]:[]), ...(showRevenue?[s3]:[]), s4, s5, s6];

      // Individual (Self-Assessment only)
      if (s.who==="individual" && !s.isSoleBusiness) {
        const a = {...s5, step:"3"};
        const b = {...s6, step:"4"};
        seqBase = [s1, s2, a, b];
      }

      // Landlord flow
      if (s.who==="landlord") {
        const a = {...s4, step:"3"};
        const b = {...s5, step:"4"};
        const c = {...s6, step:"5"};
        seqBase = [s1, s2, a, b, c];
      }

      // MOBILE render
      if(!isDesktop){
        return (
          <>
            <SnakeGrid sections={seqBase}/>
            <div className="no-print flex justify-end mt-6">
              <button className="px-5 py-2 rounded-xl bg-[var(--sbx-blue)] text-white font-semibold" onClick={onNext}>Get Quote</button>
            </div>
          </>
        );
      }

      // DESKTOP grids
      let areas = "";
      if (s.who==="individual" && !s.isSoleBusiness) {
        areas = `"s1 s2"
                 "s6 s5"`;
      } else if (s.who==="landlord") {
        areas = `"s1 s2"
                 "s5 s4"
                 "s6 ."`; /* s2 -> s4 (down), s4 -> s5 (left), s5 -> s6 (down) */
      } else if(showCIS && showRevenue){
        areas = `"s1 s2"
                 "s3 s2a"
                 "s4 s5"
                 "s6 ."`;
      } else if(showCIS && !showRevenue){
        areas = `"s1 s2"
                 "s4 s2a"
                 "s5 ."
                 "s6 ."`;
      } else if(!showCIS && showRevenue){
        areas = `"s1 s2"
                 "s4 s3"
                 "s5 s6"`;
      } else {
        areas = `"s1 s2"
                 "s4 ."
                 "s5 s6"`;
      }

      const rows = areas.trim().split("\n").map(r=>r.trim().replace(/"/g,''));
      const coords = {};
      rows.forEach((rowStr,ri)=>{
        rowStr.split(/\s+/).forEach((cell,ci)=>{
          if(cell!=='.') coords[cell] = {row:ri, col:ci};
        });
      });

      const keys = seqBase.map(s=>s.key);
      const arrows = {};
      for(let i=0;i<keys.length;i++){
        const cur=keys[i], nxt=keys[i+1];
        if(!nxt){ arrows[cur]=null; break; }
        const a=coords[cur], b=coords[nxt];
        if(!a || !b){ arrows[cur]=null; continue; }
        if(b.row===a.row && b.col>a.col) arrows[cur]="right";
        else if(b.row===a.row && b.col<a.col) arrows[cur]="left";
        else if(b.col===a.col && b.row>a.row) arrows[cur]="down";
        else if(b.row>a.row && b.col<a.col) arrows[cur]="dl";
        else if(b.row>a.row && b.col>a.col) arrows[cur]="dr";
        else arrows[cur]="down";
      }
      arrows['s2']='down';
      if(showCIS){ arrows['s2a']='left'; arrows['s3']='down'; arrows['s4']='right'; arrows['s5']='dl'; }
      else { if(showRevenue){ arrows['s3']='left'; } }
      if (s.who==="landlord") { arrows['s4']='left'; arrows['s5']='down'; }

      const gridStyle = {
        display:'grid',
        gap:'1.5rem',
        gridTemplateColumns:'1fr 1fr',
        gridTemplateAreas: rows.map(r=>`"${r}"`).join("\n")
      };

      const sectionMap = {s1,s2,s2a,s3,s4,s5,s6};

      return (
        <>
          <div style={gridStyle}>
            {Object.keys(coords).map(k=>{
              const sec = sectionMap[k]; if(!sec) return null;
              const updated = seqBase.find(x=>x.key===k) || sec;
              return (
                <div key={k} style={{gridArea:k}}>
                  <Section stepLabel={updated.step} arrow={arrows[k]} title={updated.title} subtitle={updated.subtitle}>
                    {updated.content}
                  </Section>
                </div>
              );
            })}
          </div>
          <div className="no-print flex justify-end mt-6">
            <button className="px-5 py-2 rounded-xl bg-[var(--sbx-blue)] text-white font-semibold" onClick={onNext}>Get Quote</button>
          </div>
        </>
      );
    }

    function Quote({s,onBack}){
      const q = calcPricing(s);
      const printQuote = ()=>window.print();

      const showLtdNote = (s.who==="limited");
      const showPshipNote = (s.who==="partnership" && s.bkDoWeDoIt);
      const showAnyNote = showLtdNote || showPshipNote;

      return (
        <div className="print-area">
          <div className="card p-6 mb-6">
            <div className="mb-2">
              <h2 className="text-xl font-semibold text-[var(--sbx-blue)]">Your Quote</h2>
              <p className="text-sm text-[var(--sbx-mute)]">Only relevant items are shown. No VAT is added.</p>
            </div>

            <div className="grid lg:grid-cols-2 gap-6">
              <div>
                <h3 className="text-lg font-semibold mb-2">Monthly</h3>
                {q.monthly.length===0?(
                  <p className="text-sm text-[var(--sbx-mute)]">No monthly items selected.</p>
                ):(
                  <ul className="space-y-2">
                    {q.monthly.map((l,i)=>{
                      const isNeg = (l.amount||0) < 0;
                      return (
                        <li key={i} className="flex items-start justify-between gap-4 border-b pb-2">
                          <div>
                            <p className="font-medium">{l.label}</p>
                            {l.note && <p className="text-xs text-[var(--sbx-mute)] mt-0.5">{l.note}</p>}
                          </div>
                          <div className={`font-semibold ${isNeg?'text-red-600':''}`}>
                            {isNeg ? "−"+currency(Math.abs(l.amount)) : currency(l.amount)}/mo
                          </div>
                        </li>
                      );
                    })}
                    <li className="flex items-start justify-between gap-4 pt-2">
                      <div className="font-semibold">Monthly Total</div>
                      <div className="font-semibold">{currency(q.monthlyTotal)}/mo</div>
                    </li>
                  </ul>
                )}
              </div>

              <div>
                <h3 className="text-lg font-semibold mb-2">One-off</h3>
                {q.oneoff.length===0?(
                  <p className="text-sm text-[var(--sbx-mute)]">No one-off items selected.</p>
                ):(
                  <ul className="space-y-2">
                    {q.oneoff.map((l,i)=>(
                      <li key={i} className="flex items-start justify-between gap-4 border-b pb-2">
                        <div>
                          <p className="font-medium">{l.label}</p>
                          {l.note && <p className="text-xs text-[var(--sbx-mute)] mt-0.5">{l.note}</p>}
                        </div>
                        <div className="font-semibold">{currency(l.amount)}</div>
                      </li>
                    ))}
                    <li className="flex items-start justify-between gap-4 pt-2">
                      <div className="font-semibold">One-off Total</div>
                      <div className="font-semibold">{currency(q.oneOffTotal)}</div>
                    </li>
                  </ul>
                )}
              </div>
            </div>

            {showAnyNote && (
              <div className="mt-4 text-xs text-[var(--sbx-mute)]">
                <ul className="list-disc ml-5 space-y-1">
                  {showLtdNote && <li>New Ltd company signups receive up to <strong>4 months</strong> of backdated bookkeeping free.</li>}
                  {showPshipNote && <li>New partnerships receive up to <strong>4 months</strong> of backdated bookkeeping free (aligned to the UK tax year) when we handle bookkeeping.</li>}
                </ul>
              </div>
            )}
          </div>

          <div className="no-print flex items-center justify-between gap-3">
            <div className="text-sm text-[var(--sbx-mute)]">Brand: <span className="text-[var(--sbx-blue)] font-semibold">SBX Accountants</span></div>
            <div className="flex flex-wrap gap-3 items-center">
              <button className="px-5 py-2 rounded-xl border font-semibold" onClick={onBack}>Back</button>
              <button className="px-5 py-2 rounded-xl bg-[var(--sbx-blue)] text-white font-semibold" onClick={printQuote}>Print</button>
              <a className="px-5 py-2 rounded-xl border font-semibold"
                 href="mailto:info@sbxaccountants.com?subject=New%20SBX%20Quote%20for%20follow-up&body=Hi%20SBX%20team%2C%0A%0AI%27ve%20generated%20a%20quote%20using%20the%20SBX%20Quote%20Builder.%20I%27ve%20attached%20the%20PDF%20for%20your%20review.%0A%0A(Use%20the%20Print%20button%20and%20choose%20%22Save%20as%20PDF%22%20to%20attach.)%0A%0AName%3A%20%0ACompany%2FStatus%3A%20%0AContact%3A%20%0ANotes%3A%20%0A"
                 target="_blank" rel="noopener">Email SBX</a>
              <span className="text-xs text-[var(--sbx-mute)]">Tip: use “Print” → “Save as PDF”, then attach it to the email.</span>
            </div>
          </div>
        </div>
      );
    }

    function App(){
      const s = useQuoteState();
      const [page,setPage]=React.useState(1);
      return (
        <div className="max-w-6xl mx-auto px-4 py-6">
          <header className="no-print mb-6">
            <div className="flex items-center justify-between">
              <div>
                <h1 className="text-2xl md:text-3xl font-semibold text-[var(--sbx-blue)]">SBX Quote Builder</h1>
                <p className="text-sm text-[var(--sbx-mute)]">Two quick steps. Clear, no-VAT pricing.</p>
              </div>
              <span className="text-xs px-2 py-1 rounded-full bg-blue-50 text-[var(--sbx-blue)]">Stage {page} of 2</span>
            </div>
          </header>

          {page===1 ? <InputsSnake s={s} onNext={()=>setPage(2)} /> : <Quote s={s} onBack={()=>setPage(1)} />}
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App/>);
  </script>
</body>
</html>
